---
-
# Basic playbook to bootstrap docker
  hosts: all
  name: "Bootstrap docker onto manager and workers"
  roles:
    - docker
  tasks:
  - name: "Initialize swarm manager"
    command: >
      docker swarm init --advertise-addr
      {{ docker_swarm_advertise_address | default(ansible_default_ipv4.address) }}:{{ docker_swarm_advertise_port | default(2377) }}
    failed_when: False
    when: docker_swarm_role == 'manager'
  - name: "Get join token from manager"
    command: >
      docker swarm join-token manager --quiet
    run_once: True
    changed_when: False
    register: docker_swarm_join_token
    when: docker_swarm_role == 'manager'
  - name: "Join worker to manager"
    command: >
      docker swarm join --token {{ docker_swarm_join_token.stdout }}
      {{ docker_swarm_advertise_address | default(ansible_default_ipv4.address) }}:{{ docker_swarm_advertise_port | default(2377) }}
    when: docker_swarm_role == 'worker'
  vars:
    docker_swarm_advertise_address: 10.0.5.12
    docker_swarm_advertise_port: 2377
    docker_users:
      - vagrant
